<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="stylesheet" type="text/css" href="/css/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@700&family=Inconsolata&family=Source+Code+Pro&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/65ad30df58.js" crossorigin="anonymous"></script>
  <!--<script src="/dist/mark.min.js" charset="UTF-8"></script>-->
<title>Hackthebox - Nest Writeup &mdash; fmash16's blog</title>
<meta property="og:title" content="Hackthebox - Nest Writeup" />
      <meta property="og:description" content="An easy machine in HTB standards, but is quite hard." />
      <meta property="og:type" content="article" />
      <meta property="og:url" content="github" />
      <meta property="og:image" content="https://fmash16.github.io/img/htb_nest/card.png" />

</head>

<body>
<!-- <h1 class=blogtitle>./fmash16's blog </h1> -->
<pre style="font-family:'Courier Prime';color:var(--accent-color);text-align:center;font-weight:1000">
 ___               _   ___   ___ 
|  _|_____ ___ ___| |_|_  | |  _|
|  _|     | .'|_ -|   |_| |_| . |
|_| |_|_|_|__,|___|_|_|_____|___|
                 u/fmash16's blog</pre>
<nav>
   <a href="/index.html">home</a>
   <a href="/archive.html">archive</a>
   <a href="mailto:fmash16@gmail.com">mail</a>
   <a href="https://github.com/fmash16">github</a>
   <!-- <a href="https://twitter.com/fmash16">twitter</a> -->
   <a href="https://reddit.com/user/fmash16">reddit</a>
   <a href="/about.html">whoami</a>
</nav>

<article>
<input id="toggle" type="checkbox" checked>
<label for="toggle">TOC</label>
<nav class='toc'>
    <ul>
    <li><a href="#hackthebox---nest-writeup">Hackthebox - Nest Writeup</a></li>
    <li><a href="#nmap-scan">Nmap scan</a></li>
    <li><a href="#enumeration">Enumeration</a>
    <ul>
    <li><a href="#smbclient">smbclient</a></li>
    </ul></li>
    <li><a href="#privilege-escalation---user">Privilege Escalation - User</a>
    <ul>
    <li><a href="#encrypted-password-find">Encrypted password find</a></li>
    <li><a href="#vb-script-encryption-debug">VB script encryption debug</a></li>
    </ul></li>
    <li><a href="#privilege-escalation---administrator">Privilege Escalation - Administrator</a>
    <ul>
    <li><a href="#hqk-reporting-service---port-4386">HQK reporting service - Port 4386</a></li>
    <li><a href="#debug-mode-password---ntfs-ads">DEBUG mode password - ntfs ADS</a></li>
    <li><a href="#ldap-creds-found">LDAP creds found</a></li>
    <li><a href="#decryting-encrypted-pass-debugging-hqkldap.exednspy">Decryting encrypted pass debugging HqkLdap.exe(dnSpy)</a></li>
    </ul></li>
    </ul>
</nav>
<h1 id="hackthebox---nest-writeup">Hackthebox - Nest Writeup</h1>
<p><img src="/img/htb_nest/card.png" /></p>
<h1 id="nmap-scan">Nmap scan</h1>
<p>Open ports:</p>
<ul>
<li>445/tcp microsoft-ds?</li>
<li>4386/tcp open unknown</li>
</ul>
<h1 id="enumeration">Enumeration</h1>
<h2 id="smbclient">smbclient</h2>
<p>We use smblient to list the shares. And find a share named “Data” using NULL auth.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">smbclient</span> <span class="at">-L</span> <span class="dt">\\\\</span>10.10.10.178</span></code></pre></div>
<p><img src="/img/htb_nest/1.png" /> We connect to the share using</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">smbclient</span> <span class="dt">\\\\</span>10.10.10.178<span class="dt">\\</span>Data</span></code></pre></div>
<p>We find an interesting file under <code>\Shared\Templates\HR\</code> named “Welcome Email.txt”. We get the file on our local mahcine using</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">smb:</span> <span class="dt">\S</span>hared<span class="dt">\T</span>emplates<span class="dt">\H</span>R<span class="dt">\&gt;</span> get <span class="st">&quot;Welcome Email.txt&quot;</span></span></code></pre></div>
<p>Having a look at the file we find</p>
<p><img src="/img/htb_nest/2.png" /></p>
<p>So we get some creds here. Creds found:</p>
<blockquote>
<p>Username: TempUser<br />
Password: welcome2019</p>
</blockquote>
<h1 id="privilege-escalation---user">Privilege Escalation - User</h1>
<h2 id="encrypted-password-find">Encrypted password find</h2>
<p>Logging in to the smbserver using these creds, we see that we have access to the IT folder.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">smbclient</span> <span class="dt">\\\\</span>10.10.10.178<span class="dt">\\</span>Data <span class="at">-U</span> TempUser%welcome2019</span></code></pre></div>
<p>We find an intersting file RU_config.xml under <code>\IT\Configs\RU Scanner\</code>. Catting out the contents, we find some creds here</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="fu">?&gt;</span> &lt;<span class="ot">ConfigFile</span> <span class="er">xmlns:xsi</span><span class="ot">=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="ot"> xmlns:xsd=</span><span class="st">&quot;http://www.w3.org/2001/XMLSchema&quot;</span>&gt; &lt;<span class="ot">Port</span><span class="er">&gt;389&lt;/Port&gt;</span> <span class="er">&lt;Username&gt;c.smith&lt;/Username&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="er">&lt;Password&gt;fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE</span><span class="ot">=</span><span class="er">&lt;/Password&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="er">&lt;/ConfigFile&gt;</span></span></code></pre></div>
<p>The password seems to be base64 encoded. So we decode it</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE= <span class="kw">|</span> <span class="ex">base64</span> <span class="at">-d</span></span></code></pre></div>
<p>The password includes unicode characters. So the hash is not base64. We look around the smbshare more and find something interesting in the config.xml file of notepad++</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span><span class="fu">History</span> nbMaxFile<span class="op">=</span><span class="st">&quot;15&quot;</span> inSubMenu<span class="op">=</span><span class="st">&quot;no&quot;</span> customLength<span class="op">=</span><span class="st">&quot;-1&quot;</span><span class="op">&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>File filename<span class="op">=</span><span class="st">&quot;C:\windows\System32\drivers\etc\hosts&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>File filename<span class="op">=</span><span class="st">&quot;\\HTB-NEST\Secure$\IT\Carl\Temp.txt&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>File filename<span class="op">=</span><span class="st">&quot;C:\Users\C.Smith\Desktop\todo.txt&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span><span class="fu">History</span><span class="op">&gt;</span></span></code></pre></div>
<h2 id="vb-script-encryption-debug">VB script encryption debug</h2>
<p>In “VB Projects/WIP/RU/RUScanner” we find some visual basic scripts. These seem to perform the encryption and decryption of the password of the user. The script Utils.vb contains the decrypt funciton. We can use this script to decrypt the encrypted pass we found using online vb.net compiler <a href="https://dotnetfiddle.net/bjoBP6">here.</a></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode vb"><code class="sourceCode monobasic"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">Imports</span> System</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">Imports</span> System.Text</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">Imports</span> System.Security.Cryptography</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">Public</span> <span class="kw">Module </span>Module1</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">Public</span> <span class="kw">Sub </span>Main()Main</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    Console.WriteLine(<span class="st">&quot;Decrypted: &quot;</span> + DecryptString(EncryptString(<span class="st">&quot;fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=&quot;</span>)))</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">End Sub</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Public</span> <span class="kw">Function </span>DecryptString(EncryptedString <span class="kw">As</span> <span class="dt">String</span>) <span class="kw">As</span> <span class="dt">String</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">If </span><span class="dt">String</span>.IsNullOrEmpty(EncryptedString) <span class="kw">Then</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>            <span class="kw">Return</span> <span class="dt">String</span>.Empty</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Else</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>            <span class="kw">Return</span> Decrypt(EncryptedString, <span class="st">&quot;N3st22&quot;</span>, <span class="st">&quot;88552299&quot;</span>, 2, <span class="st">&quot;464R5DFA5DL6LE28&quot;</span>, 256)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">End If</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">End Function</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Public</span> <span class="kw">Function </span>EncryptString(PlainString <span class="kw">As</span> <span class="dt">String</span>) <span class="kw">As</span> <span class="dt">String</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">If </span><span class="dt">String</span>.IsNullOrEmpty(PlainString) <span class="kw">Then</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">Return</span> <span class="dt">String</span>.Empty</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Else</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">Return</span> Encrypt(PlainString, <span class="st">&quot;N3st22&quot;</span>, <span class="st">&quot;88552299&quot;</span>, 2, <span class="st">&quot;464R5DFA5DL6LE28&quot;</span>, 256)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">End If</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">End Function</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Public</span> <span class="kw">Function </span>Encrypt(<span class="kw">ByVal</span> plainText <span class="kw">As</span> <span class="dt">String</span>, _</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>                                   <span class="kw">ByVal</span> passPhrase <span class="kw">As</span> <span class="dt">String</span>, _</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>                                   <span class="kw">ByVal</span> saltValue <span class="kw">As</span> <span class="dt">String</span>, _</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>                                    <span class="kw">ByVal</span> passwordIterations <span class="kw">As</span> <span class="dt">Integer</span>, _</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>                                   <span class="kw">ByVal</span> initVector <span class="kw">As</span> <span class="dt">String</span>, _</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>                                   <span class="kw">ByVal</span> keySize <span class="kw">As</span> <span class="dt">Integer</span>) _</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>                           <span class="kw">As</span> <span class="dt">String</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> initVectorBytes <span class="kw">As</span> <span class="dt">Byte</span>() = Encoding.ASCII.GetBytes(initVector)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> saltValueBytes <span class="kw">As</span> <span class="dt">Byte</span>() = Encoding.ASCII.GetBytes(saltValue)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> plainTextBytes <span class="kw">As</span> <span class="dt">Byte</span>() = Encoding.ASCII.GetBytes(plainText)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> password <span class="kw">As</span> <span class="kw">New</span> Rfc2898DeriveBytes(passPhrase, _</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>                                           saltValueBytes, _</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>                                           passwordIterations)</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> keyBytes <span class="kw">As</span> <span class="dt">Byte</span>() = password.GetBytes(CInt(keySize / 8))</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> symmetricKey <span class="kw">As</span> <span class="kw">New</span> AesCryptoServiceProvider</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        symmetricKey.Mode = CipherMode.CBC</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> encryptor <span class="kw">As</span> ICryptoTransform</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>= symmetricKey.CreateEncryptor(keyBytes, initVectorBytes)</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>        Using memoryStream <span class="kw">As</span> <span class="kw">New</span> IO.MemoryStream()</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>            Using cryptoStream <span class="kw">As</span> <span class="kw">New</span> CryptoStream(memoryStream, _</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>                                            encryptor, _</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>                                            CryptoStreamMode.Write)</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>                cryptoStream.Write(plainTextBytes, 0, plainTextBytes.Length)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>                cryptoStream.FlushFinalBlock()</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>                <span class="kw">Dim</span> cipherTextBytes <span class="kw">As</span> <span class="dt">Byte</span>() = memoryStream.ToArray()</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>                memoryStream.Close()</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>                cryptoStream.Close()</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>                <span class="kw">Return</span> Convert.ToBase64String(cipherTextBytes)</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>            End Using</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>        End Using</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">End Function</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">Public</span> <span class="kw">Function </span>Decrypt(<span class="kw">ByVal</span> cipherText <span class="kw">As</span> <span class="dt">String</span>, _</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>                                   <span class="kw">ByVal</span> passPhrase <span class="kw">As</span> <span class="dt">String</span>, _</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>                                   <span class="kw">ByVal</span> saltValue <span class="kw">As</span> <span class="dt">String</span>, _</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>                                    <span class="kw">ByVal</span> passwordIterations <span class="kw">As</span> <span class="dt">Integer</span>, _</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>                                   <span class="kw">ByVal</span> initVector <span class="kw">As</span> <span class="dt">String</span>, _</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>                                   <span class="kw">ByVal</span> keySize <span class="kw">As</span> <span class="dt">Integer</span>) _</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>                           <span class="kw">As</span> <span class="dt">String</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> initVectorBytes <span class="kw">As</span> <span class="dt">Byte</span>()</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>        initVectorBytes = Encoding.ASCII.GetBytes(initVector)</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> saltValueBytes <span class="kw">As</span> <span class="dt">Byte</span>()</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>        saltValueBytes = Encoding.ASCII.GetBytes(saltValue)</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> cipherTextBytes <span class="kw">As</span> <span class="dt">Byte</span>()</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>        cipherTextBytes = Convert.FromBase64String(cipherText)</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> password <span class="kw">As</span> <span class="kw">New</span> Rfc2898DeriveBytes(passPhrase, _</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>                                           saltValueBytes, _</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>                                           passwordIterations)</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> keyBytes <span class="kw">As</span> <span class="dt">Byte</span>()</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>        keyBytes = password.GetBytes(CInt(keySize / 8))</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> symmetricKey <span class="kw">As</span> <span class="kw">New</span> AesCryptoServiceProvider</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>        symmetricKey.Mode = CipherMode.CBC</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> decryptor <span class="kw">As</span> ICryptoTransform</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>        decryptor = symmetricKey.CreateDecryptor(keyBytes, initVectorBytes)</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> memoryStream <span class="kw">As</span> IO.MemoryStream</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>        memoryStream = <span class="kw">New</span> IO.MemoryStream(cipherTextBytes)</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> cryptoStream <span class="kw">As</span> CryptoStream</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>        cryptoStream = <span class="kw">New</span> CryptoStream(memoryStream, _</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>                                        decryptor, _</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>                                        CryptoStreamMode.Read)</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> plainTextBytes <span class="kw">As</span> <span class="dt">Byte</span>()</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>        <span class="kw">ReDim</span> plainTextBytes(cipherTextBytes.Length)</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> decryptedByteCount <span class="kw">As</span> <span class="dt">Integer</span></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>        decryptedByteCount = cryptoStream.Read(plainTextBytes, _</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>                                               0, _</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>                                               plainTextBytes.Length)</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>        memoryStream.Close()</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>        cryptoStream.Close()</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Dim</span> plainText <span class="kw">As</span> <span class="dt">String</span></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>        plainText = Encoding.ASCII.GetString(plainTextBytes, _</span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>                                            0, _</span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>                                            decryptedByteCount)</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>        <span class="kw">Return</span> plainText</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>    <span class="kw">End Function</span></span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a><span class="kw">End Module</span></span></code></pre></div>
<p>Decrypting, we find the password.</p>
<p>Creds found:</p>
<blockquote>
<p>User: c.smith<br />
Password: xRxRxPANCAK3SxRxRx</p>
</blockquote>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">smbclient</span> <span class="dt">\\\\</span>10.10.10.178<span class="dt">\\</span>Users <span class="at">-U</span> c.smith%xRxRxPANCAK3SxRxRx</span></code></pre></div>
<p>Listing the files recursively, we find our required user.txt</p>
<h1 id="privilege-escalation---administrator">Privilege Escalation - Administrator</h1>
<h2 id="hqk-reporting-service---port-4386">HQK reporting service - Port 4386</h2>
<p>From the nmap port scan, we found an open port 4386. Banner grabbing using nc, we find a service “HQK Reporting Service V1.2” running on the port. We get a prompt but cannot execute any commands connecting with nc. We try with telned and get success.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">telnet</span> 10.10.10.178 4386</span></code></pre></div>
<h2 id="debug-mode-password---ntfs-ads">DEBUG mode password - ntfs ADS</h2>
<p>But we have limited execution. We can enter a debuyg mode using a debug mode password. We found a file named “Debug Mode Password.txt” in the <code>Users\C.Smith</code> share. We see that the file is empty. Looking around for quite a while, and using some help from the forum , I came to know of <a href="https://blog.malwarebytes.com/101/2015/07/introduction-to-alternate-data-streams/">ntfs alternate data streams</a>. So basically, data can be stored in the ntfs files in a different stream for obsfucation. We can see that the file has an alternate data stream using allinfo command. We can get the data from the alternate stream executing the following</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">smb:</span> <span class="dt">\C</span>.Smith<span class="dt">\H</span>QK Reporting<span class="dt">\&gt;</span> allinfo <span class="st">&quot;Debug Mode Password.txt&quot;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">smb:</span> <span class="dt">\C</span>.Smith<span class="dt">\H</span>QK Reporting<span class="dt">\&gt;</span> get <span class="st">&quot;Debug Mode Password.txt:Password&quot;</span></span></code></pre></div>
<p>Creds found: &gt; Password: WBQ201953D8w</p>
<h2 id="ldap-creds-found">LDAP creds found</h2>
<p>Now, we can use this password to enter debug mode on HQK and get more access to the files. Looking around, we see that directory ../ is HQK/ and contains a folder /LDAP. Going to the directory, we find a file ldap.conf that gives us the creds for the administrator.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>Domain=nest.local</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>Port=389</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>BaseOu=OU=WBQ Users,OU=Production,DC=nest,DC=local</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>User=Administrator</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>Password=yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4=</span></code></pre></div>
<p>Creds found:</p>
<blockquote>
<p>User: Administrator<br />
Password: yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4=</p>
</blockquote>
<h2 id="decryting-encrypted-pass-debugging-hqkldap.exednspy">Decryting encrypted pass debugging HqkLdap.exe(dnSpy)</h2>
<p>The password is encrypted. We also found a HqkLdap.exe file there. We can have a look at the file. We found this file in the Users share under “C.Smith/HQK Reporting/AD Integration Module/”. The file is a .NET binary.</p>
<p>In order to debug the file, we use a tool called <a href="https://github.com/0xd4d/dnSpy">dnSpy</a> We can decompile the binary into C# code. Looking at the code, we find a class <code>HqkLdap.CR</code> that has a function <code>DS</code> which decrypts the string provided. So we can use this function to decrypt our obtained hash.</p>
<p><img src="/img/htb_nest/dnspy.png" /></p>
<p>We head over to the awesome <a href="https://dotnetfiddle.net/o4iGop">.netfidler</a> and edit our C# script to decrypt our hash. The script stands</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c#"><code class="sourceCode cs"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">IO</span><span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Security</span><span class="op">.</span><span class="fu">Cryptography</span><span class="op">;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Text</span><span class="op">;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Program</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span> <span class="kw">static</span> <span class="dt">void</span> <span class="fu">Main</span><span class="op">()</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span><span class="st">&quot;Decrypting Admin Hash...&quot;</span><span class="op">);</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span>CR<span class="op">.</span><span class="fu">DS</span><span class="op">(</span><span class="st">&quot;yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4=&quot;</span><span class="op">));</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CR</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Token: 0x06000012 RID: 18 RVA: 0x00002278 File Offset: 0x00000678</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="dt">string</span> <span class="fu">DS</span><span class="op">(</span><span class="dt">string</span> EncryptedString<span class="op">)</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">if</span> <span class="op">(</span><span class="dt">string</span><span class="op">.</span><span class="fu">IsNullOrEmpty</span><span class="op">(</span>EncryptedString<span class="op">))</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="dt">string</span><span class="op">.</span><span class="fu">Empty</span><span class="op">;</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> CR<span class="op">.</span><span class="fu">RD</span><span class="op">(</span>EncryptedString<span class="op">,</span> <span class="st">&quot;667912&quot;</span><span class="op">,</span> <span class="st">&quot;1313Rf99&quot;</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="st">&quot;1L1SA61493DRV53Z&quot;</span><span class="op">,</span> <span class="dv">256</span><span class="op">);</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Token: 0x06000013 RID: 19 RVA: 0x000022B0 File Offset: 0x000006B0</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="dt">string</span> <span class="fu">ES</span><span class="op">(</span><span class="dt">string</span> PlainString<span class="op">)</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>      <span class="kw">if</span> <span class="op">(</span><span class="dt">string</span><span class="op">.</span><span class="fu">IsNullOrEmpty</span><span class="op">(</span>PlainString<span class="op">))</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="dt">string</span><span class="op">.</span><span class="fu">Empty</span><span class="op">;</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> CR<span class="op">.</span><span class="fu">RE</span><span class="op">(</span>PlainString<span class="op">,</span> <span class="st">&quot;667912&quot;</span><span class="op">,</span> <span class="st">&quot;1313Rf99&quot;</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="st">&quot;1L1SA61493DRV53Z&quot;</span><span class="op">,</span> <span class="dv">256</span><span class="op">);</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Token: 0x06000014 RID: 20 RVA: 0x000022E8 File Offset: 0x000006E8</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">static</span> <span class="dt">string</span> <span class="fu">RE</span><span class="op">(</span><span class="dt">string</span> plainText<span class="op">,</span> <span class="dt">string</span> passPhrase<span class="op">,</span> <span class="dt">string</span> saltValue<span class="op">,</span> <span class="dt">int</span> passwordIterations<span class="op">,</span> <span class="dt">string</span> initVector<span class="op">,</span> <span class="dt">int</span> keySize<span class="op">)</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>      <span class="dt">byte</span><span class="op">[]</span> bytes <span class="op">=</span> Encoding<span class="op">.</span><span class="fu">ASCII</span><span class="op">.</span><span class="fu">GetBytes</span><span class="op">(</span>initVector<span class="op">);</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>      <span class="dt">byte</span><span class="op">[]</span> bytes2 <span class="op">=</span> Encoding<span class="op">.</span><span class="fu">ASCII</span><span class="op">.</span><span class="fu">GetBytes</span><span class="op">(</span>saltValue<span class="op">);</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>      <span class="dt">byte</span><span class="op">[]</span> bytes3 <span class="op">=</span> Encoding<span class="op">.</span><span class="fu">ASCII</span><span class="op">.</span><span class="fu">GetBytes</span><span class="op">(</span>plainText<span class="op">);</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>      Rfc2898DeriveBytes rfc2898DeriveBytes <span class="op">=</span> <span class="kw">new</span> <span class="fu">Rfc2898DeriveBytes</span><span class="op">(</span>passPhrase<span class="op">,</span> bytes2<span class="op">,</span> passwordIterations<span class="op">);</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>      <span class="dt">byte</span><span class="op">[]</span> bytes4 <span class="op">=</span> rfc2898DeriveBytes<span class="op">.</span><span class="fu">GetBytes</span><span class="op">(</span><span class="kw">checked</span><span class="op">((</span><span class="dt">int</span><span class="op">)</span>Math<span class="op">.</span><span class="fu">Round</span><span class="op">((</span><span class="dt">double</span><span class="op">)</span>keySize <span class="op">/</span> <span class="fl">8.0</span><span class="op">)));</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>      ICryptoTransform transform <span class="op">=</span> <span class="kw">new</span> AesCryptoServiceProvider</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>        Mode <span class="op">=</span> CipherMode<span class="op">.</span><span class="fu">CBC</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>      <span class="op">}.</span><span class="fu">CreateEncryptor</span><span class="op">(</span>bytes4<span class="op">,</span> bytes<span class="op">);</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>      <span class="dt">string</span> result<span class="op">;</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>      <span class="kw">using</span> <span class="op">(</span>MemoryStream memoryStream <span class="op">=</span> <span class="kw">new</span> <span class="fu">MemoryStream</span><span class="op">())</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">using</span> <span class="op">(</span>CryptoStream cryptoStream <span class="op">=</span> <span class="kw">new</span> <span class="fu">CryptoStream</span><span class="op">(</span>memoryStream<span class="op">,</span> transform<span class="op">,</span> CryptoStreamMode<span class="op">.</span><span class="fu">Write</span><span class="op">))</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>          cryptoStream<span class="op">.</span><span class="fu">Write</span><span class="op">(</span>bytes3<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> bytes3<span class="op">.</span><span class="fu">Length</span><span class="op">);</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>          cryptoStream<span class="op">.</span><span class="fu">FlushFinalBlock</span><span class="op">();</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>          <span class="dt">byte</span><span class="op">[]</span> inArray <span class="op">=</span> memoryStream<span class="op">.</span><span class="fu">ToArray</span><span class="op">();</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>          memoryStream<span class="op">.</span><span class="fu">Close</span><span class="op">();</span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>          cryptoStream<span class="op">.</span><span class="fu">Close</span><span class="op">();</span></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>          result <span class="op">=</span> Convert<span class="op">.</span><span class="fu">ToBase64String</span><span class="op">(</span>inArray<span class="op">);</span></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> result<span class="op">;</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Token: 0x06000015 RID: 21 RVA: 0x000023DC File Offset: 0x000007DC</span></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">static</span> <span class="dt">string</span> <span class="fu">RD</span><span class="op">(</span><span class="dt">string</span> cipherText<span class="op">,</span> <span class="dt">string</span> passPhrase<span class="op">,</span> <span class="dt">string</span> saltValue<span class="op">,</span> <span class="dt">int</span> passwordIterations<span class="op">,</span> <span class="dt">string</span> initVector<span class="op">,</span> <span class="dt">int</span> keySize<span class="op">)</span></span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>      <span class="dt">byte</span><span class="op">[]</span> bytes <span class="op">=</span> Encoding<span class="op">.</span><span class="fu">ASCII</span><span class="op">.</span><span class="fu">GetBytes</span><span class="op">(</span>initVector<span class="op">);</span></span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>      <span class="dt">byte</span><span class="op">[]</span> bytes2 <span class="op">=</span> Encoding<span class="op">.</span><span class="fu">ASCII</span><span class="op">.</span><span class="fu">GetBytes</span><span class="op">(</span>saltValue<span class="op">);</span></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>      <span class="dt">byte</span><span class="op">[]</span> array <span class="op">=</span> Convert<span class="op">.</span><span class="fu">FromBase64String</span><span class="op">(</span>cipherText<span class="op">);</span></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>      Rfc2898DeriveBytes rfc2898DeriveBytes <span class="op">=</span> <span class="kw">new</span></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a><span class="fu">Rfc2898DeriveBytes</span><span class="op">(</span>passPhrase<span class="op">,</span> bytes2<span class="op">,</span> passwordIterations<span class="op">);</span></span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>      <span class="kw">checked</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>        <span class="dt">byte</span><span class="op">[]</span> bytes3 <span class="op">=</span> rfc2898DeriveBytes<span class="op">.</span><span class="fu">GetBytes</span><span class="op">((</span><span class="dt">int</span><span class="op">)</span>Math<span class="op">.</span><span class="fu">Round</span><span class="op">((</span><span class="dt">double</span><span class="op">)</span>keySize <span class="op">/</span> <span class="fl">8.0</span><span class="op">));</span></span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>        ICryptoTransform transform <span class="op">=</span> <span class="kw">new</span> AesCryptoServiceProvider</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>          Mode <span class="op">=</span> CipherMode<span class="op">.</span><span class="fu">CBC</span></span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>        <span class="op">}.</span><span class="fu">CreateDecryptor</span><span class="op">(</span>bytes3<span class="op">,</span> bytes<span class="op">);</span></span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>        MemoryStream memoryStream <span class="op">=</span> <span class="kw">new</span> <span class="fu">MemoryStream</span><span class="op">(</span>array<span class="op">);</span></span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>        CryptoStream cryptoStream <span class="op">=</span> <span class="kw">new</span> <span class="fu">CryptoStream</span><span class="op">(</span>memoryStream<span class="op">,</span> transform<span class="op">,</span> CryptoStreamMode<span class="op">.</span><span class="fu">Read</span><span class="op">);</span></span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>        <span class="dt">byte</span><span class="op">[]</span> array2 <span class="op">=</span> <span class="kw">new</span> <span class="dt">byte</span><span class="op">[</span>array<span class="op">.</span><span class="fu">Length</span> <span class="op">+</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> count <span class="op">=</span> cryptoStream<span class="op">.</span><span class="fu">Read</span><span class="op">(</span>array2<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> array2<span class="op">.</span><span class="fu">Length</span><span class="op">);</span></span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>        memoryStream<span class="op">.</span><span class="fu">Close</span><span class="op">();</span></span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>        cryptoStream<span class="op">.</span><span class="fu">Close</span><span class="op">();</span></span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> Encoding<span class="op">.</span><span class="fu">ASCII</span><span class="op">.</span><span class="fu">GetString</span><span class="op">(</span>array2<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> count<span class="op">);</span></span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Token: 0x04000006 RID: 6</span></span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">const</span> <span class="dt">string</span> K <span class="op">=</span> <span class="st">&quot;667912&quot;</span><span class="op">;</span></span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Token: 0x04000007 RID: 7</span></span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">const</span> <span class="dt">string</span> I <span class="op">=</span> <span class="st">&quot;1L1SA61493DRV53Z&quot;</span><span class="op">;</span></span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Token: 0x04000008 RID: 8</span></span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">const</span> <span class="dt">string</span> SA <span class="op">=</span> <span class="st">&quot;1313Rf99&quot;</span><span class="op">;</span></span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>Running the script, we get our decrypted password for administrator.</p>
<p><img src="/img/htb_nest/3.png" /></p>
<p>Creds found:</p>
<blockquote>
<p>User: Administrator<br />
Password: XtH4nkS4Pl4y1nGX</p>
</blockquote>
<p>Now we use the creds to get into the C$ share on smb</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">smbclient</span> <span class="dt">\\\\</span>10.10.10.178<span class="dt">\\</span>Users <span class="at">-U</span> Administrator%XtH4nkS4Pl4y1nGX</span></code></pre></div>
<p>We successfully got in. Now we can read our root.txt file from <code>C:\Users\Administrator\Desktop\root.txt</code></p>
</article>

<footer>
  <hr>
  <p> Generated with a modified version of <a
      href="https://github.com/fmash16/ssg5">ssg5</a> By u/fmash16 <br /> 
  <i class="far fa-copyright"></i> 2020-2021 </p>
</footer>
</body>
